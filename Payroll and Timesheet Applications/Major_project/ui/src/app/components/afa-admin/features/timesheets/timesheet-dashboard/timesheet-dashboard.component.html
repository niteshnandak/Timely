<div>
  <app-loader [isLoading]="isLoading"></app-loader>
  <div class="go-back-button d-flex align-items-center">
    <a routerLink="/company/company-details" class="tms-back">
      <i class="bi bi-arrow-left"></i>&nbsp; &nbsp;<span>Back</span>
    </a>
  </div>
  <div class="d-flex justify-content-between align-items-center ms-4">
    <h4 class="mb-3">{{company_name}} / Timesheets</h4>
    <div class="d-flex align-items-center">
      <div class="refresh-bttn text-black me-3" title="Refresh" (click)="refreshData()">
        <i class="rotate-icon bi bi-arrow-clockwise h4"></i>
      </div>
      <button class="btn btn-primary me-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample"
        aria-expanded="false" aria-controls="collapseExample">
        <i class="bi bi-search me-1"></i>
        Search
      </button>
      <button class="btn btn-success me-2" (click)="openModal('create')"><i class="bi bi-plus-lg"></i> Create </button>
      <button class="btn btn-info me-4" (click)="openModal('upload')"><i class="bi bi-upload"></i> Upload </button>
    </div>
  </div>
  <div class="collapse mt-3" id="collapseExample">
    <div class="card card-body">
      <form [formGroup]="searchTimesheetForm" (ngSubmit)="searchTimesheetFormSubmit()">
        <div class="d-flex flex-wrap">
          <div class="form-group me-3">
            <label for="timesheet_num">Timesheet Number</label>
            <input type="text" class="form-control text-dark" placeholder="Enter Timesheet Number" name="timesheet_num"
              id="timesheet_num" formControlName="timesheet_num">
          </div>
          <div class="form-group me-3">
            <label for="timesheet_name">Timesheet Name</label>
            <input type="text" class="form-control text-dark" placeholder="Enter Timesheet Name" name="timesheet_name"
              id="timesheet_name" formControlName="timesheet_name">
          </div>
          <div class="form-group me-3">
            <label for="period_end_date">Period End Date</label>
            <input type="date" class="form-control text-dark" placeholder="YYYY-MM-DD" name="period_end_date"
              id="period_end_date" formControlName="period_end_date">
          </div>
          <div class="form-group me-3">
            <label for="upload_type">Upload Type</label>
            <select class="form-select" name="upload_type" id="upload_type" formControlName="upload_type">
              <option [ngValue]="null">Select Invoice Status</option>
              <option value="manual">manual</option>
              <option value="csv">csv</option>
            </select>
          </div>
          <div class="form-group me-3">
            <label for="invoice_status">Invoice Status</label>
            <select class="form-select" name="invoice_status" id="invoice_status" formControlName="invoice_status">
              <option [ngValue]="null">Select Invoice Status</option>
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
              <option value="Completed with Errors">Completed with Errors</option>
            </select>
          </div>
          <div class="ms-auto">
            <button class="btn btn-primary me-3" type="button" (click)="searchTimesheetResetForm()">
              Reset
            </button>
            <button class="btn btn-success" type="submit">
              Search
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="grid-container px-3 mt-2">
    <kendo-grid [data]="timesheets" [pageSize]="perPage" [skip]="(currentPage - 1) * perPage" [pageable]="{
      buttonCount: buttonCount,
      info: info,
      type: type,
      pageSizes: pageSizes,
      previousNext: previousNext,
      position: position
    }"
      [total]="total" [loading]="gridLoading" (pageChange)="onPageChange($event)">
      <kendo-grid-column field="timesheet_num" title="Number" [headerStyle]="{'font-weight':'bold'}" [width]="90">
      </kendo-grid-column>
      <kendo-grid-column field="timesheet_name" title="Name" [headerStyle]="{'font-weight':'bold'}" [width]="110">
        <ng-template kendoGridCellTemplate let-dataItem>
            <span class="custom-cell text-truncate" kendoTooltip [title]="dataItem.timesheet_name">
              {{dataItem.timesheet_name}}
            </span>
        </ng-template>
      </kendo-grid-column>
      <kendo-grid-column field="num_of_rows" title="Timesheetdetail count" [headerStyle]="{'font-weight':'bold'}"
        [width]="110">
        <ng-template kendoGridCellTemplate let-dataItem>
          <div style="text-align: center;">
            <span kendoTooltip [title]="dataItem.num_of_rows">
              {{dataItem.num_of_rows}}
            </span>
          </div>
        </ng-template>
      </kendo-grid-column>
      <kendo-grid-column field="period_end_date" title="Period End Date" [headerStyle]="{'font-weight':'bold'}"
        [width]="90">
        <ng-template kendoGridCellTemplate let-dataItem>
          {{dataItem.period_end_date|date:'dd-MM-YYYY'}}
        </ng-template>
      </kendo-grid-column>
      <kendo-grid-column field="upload_type" title="Upload Type" [headerStyle]="{'font-weight':'bold'}" [width]="80">
      </kendo-grid-column>
      <kendo-grid-column field="invoice_status" title="Invoice Status" [headerStyle]="{'font-weight':'bold'}"
        [width]="110">
        <ng-template kendoGridCellTemplate let-dataItem>
          <div class="button-container">
            @if (dataItem.invoice_status === 'Pending') {
            <span class="badge rounded-pill text-bg-warning">Pending</span>
            }@else if (dataItem.invoice_status === 'In Progress'){
            <span class="badge rounded-pill text-bg-info">In Progress</span>
            }@else if (dataItem.invoice_status === 'Completed'){
            <span class="badge rounded-pill text-bg-success">Completed</span>
            }@else{
            <span class="badge rounded-pill text-bg-danger">Completed with Errors</span>
            }
          </div>
        </ng-template>
      </kendo-grid-column>
      <kendo-grid-column field="Action" title="Action" [headerStyle]="{'font-weight':'bold'}" [width]="80">
        <ng-template kendoGridCellTemplate let-dataItem>
          <button *ngIf="dataItem.invoice_status !== 'Pending'" class="btn btn-sm btn-smaller"
            title="View Timesheet Details" tooltip="View Timesheet Details"
            (click)="navigateToTimesheetDetails(dataItem)">
            <i class="fas fa-eye"></i>
          </button>
          <button *ngIf="dataItem.invoice_status === 'Pending'" class="btn btn-sm btn-smaller"
            title="Edit Timesheet Details" tooltip="Edit Timesheet Details"
            (click)="navigateToTimesheetDetails(dataItem)">
            <i class="fas fa-edit" style="font-weight: bold;"></i>
          </button>

          <button class="btn btn-sm btn-smaller btn-delete" *ngIf="dataItem.invoice_status == 'Pending'"
            title="Delete Timesheet" tooltip="Delete Timesheet" data-bs-toggle="modal"
            data-bs-target="#deleteTimesheetModal" (click)="setDataItem(dataItem.timesheet_id)">
            <i class="fas fa-trash"></i>
          </button>
        </ng-template>
      </kendo-grid-column>
    </kendo-grid>
  </div>
</div>

<div class="modal fade" id="deleteTimesheetModal" tabindex="-1" aria-labelledby="deleteTimesheetModal"
  aria-hidden="true">
  <div class="modal-dialog  modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="deleteTimesheetModal">Delete Timesheet</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure want to Delete this Timesheet?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" data-bs-dismiss="modal"
          (click)="deleteTimesheetData(deleteTimesheetId)">Proceed</button>
      </div>
    </div>
  </div>
</div>

<app-modal [isVisible]="createModalVisible" (closeModal)="closeModal('create')">
  <div class="modal-title d-flex align-items-center">
    <p class="upload-csv-header">Create Timesheet</p>
  </div>
  <div class="modal-content">
    <div class="upload-timesheet-form">
      <form [formGroup]="addTimesheetForm" (ngSubmit)="addTimesheetFormSubmit()">
        <div class="upload-form-group">
          <label for="timesheet_name">Timesheet Name <span class="text-danger">*</span></label>
          <input type="text" class="form-control text-dark" placeholder="Enter Timesheet Name" name="timesheet_name"
            id="timesheet_name" formControlName="timesheet_name" appNumbersAndchars>
          <div class="error-div">
            @if (timesheetName?.errors?.['required'] && (timesheetName?.touched || timesheetName?.dirty)) {
            <b><small class="error-message">*Name field is required</small></b>
            }
          </div>
        </div>
        <div class="upload-form-group">
          <label for="period_end_date">Period End Date <span class="text-danger">*</span></label>
          <input type="date" class="form-control text-dark" placeholder="YYYY-MM-DD" name="period_end_date"
            id="period_end_date" formControlName="period_end_date" (click)="handleDatePickerOpen(periodEndDate)">
          <div class="error-div">
            @if (periodEndDate?.errors?.['required'] && (periodEndDate?.touched || periodEndDate?.dirty)) {
            <b><small class="error-message">*Period End Date field is required</small></b>
            }
            @if (periodEndDate?.errors?.['pastDateTooFar'] && (periodEndDate?.dirty)) {
            <b><small class="error-message">*Period End Date can't be less than 1 year in the past.</small></b>
            }
            @if (periodEndDate?.errors?.['futureDateTooFar'] && (periodEndDate?.dirty)) {
            <b><small class="error-message">*Period End Date can't be beyond 1 year in the future</small></b>
            }
          </div>
        </div>
        <div class="upload-form-group">
          <label for="invoice_date">Invoice Date <span class="text-danger">*</span></label>
          <input type="date" class="form-control text-dark" placeholder="YYYY-MM-DD" name="invoice_date"
            id="invoice_date" formControlName="invoice_date" (click)="handleDatePickerOpen(invoiceDate)">
          <div class="error-div">
            @if (invoiceDate?.errors?.['required'] && (invoiceDate?.touched || invoiceDate?.dirty)) {
            <b><small class="error-message">*Invoice Date field is required</small></b>
            }
            @if (invoiceDate?.errors?.['pastDateTooFar'] && (invoiceDate?.dirty)) {
            <b><small class="error-message">*Invoice Date can't be less than a year in the past</small></b>
            }
            @if (invoiceDate?.errors?.['futureDateTooFar'] && (invoiceDate?.dirty)) {
            <b><small class="error-message">*Invoice Date can't be more than a year in the future</small></b>
            }
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success me-2" [disabled]="!(this.addTimesheetForm.valid)">Save</button>
          <button type="Reset" class="btn btn-secondary" (click)="resetForm(addTimesheetForm)">Reset</button>
        </div>
      </form>
    </div>
  </div>
</app-modal>

<app-modal [isVisible]="uploadModalVisible" (closeModal)="closeModal('upload')">
  <div class="modal-title d-flex align-items-center">
    <p class="upload-csv-header">Upload Timesheet</p>&nbsp;&nbsp;<p class="upload-csv">( .csv files only )</p>
  </div>
  <div class="modal-content">
    <div class="upload-timesheet-form">
      <form [formGroup]="uploadTimesheetForm" (ngSubmit)="onSubmit()">
        <div class="upload-form-group">
          <label for="timesheet_name">Timesheet Name <span class="text-danger">*</span></label>
          <input type="text" formControlName="timesheet_name" placeholder="Enter Timesheet Name" appNumbersAndchars>
          <div class="error-div">
            @if (uploadTimesheetForm.get('timesheet_name')?.errors?.['required'] &&
            (uploadTimesheetForm.get('timesheet_name')?.touched || uploadTimesheetForm.get('timesheet_name')?.dirty)) {
            <b><small class="error-message">*Timesheet Name field is required</small></b>
            }
          </div>
        </div>
        <div class="upload-form-group">
          <label for="period_end_date">Period End Date <span class="text-danger">*</span></label>
          <input type="date" class="upload-form-date" formControlName="period_end_date"
            (click)="handleDatePickerOpen(uploadTimesheetForm.get('period_end_date'))">
          <div class="error-div">
            @if (uploadTimesheetForm.get('period_end_date')?.errors?.['required'] &&
            (uploadTimesheetForm.get('period_end_date')?.touched || uploadTimesheetForm.get('period_end_date')?.dirty))
            {
            <b><small class="error-message">*Period End Date field is required</small></b>
            }
            @if (uploadTimesheetForm.get('period_end_date')?.errors?.['pastDateTooFar'] &&
            (uploadTimesheetForm.get('period_end_date')?.dirty)) {
            <b><small class="error-message">*Date can't be less than 1 year in the past.</small></b>
            }
            @if (uploadTimesheetForm.get('period_end_date')?.errors?.['futureDateTooFar'] &&
            (uploadTimesheetForm.get('period_end_date')?.dirty)) {
            <b><small class="error-message">*Date can't be beyond 1 year in the future</small></b>
            }
          </div>
        </div>
        <div class="upload-form-group">
          <label for="invoice_date">Invoice Date <span class="text-danger">*</span></label>
          <input type="date" class="upload-form-date" formControlName="invoice_date"
            (click)="handleDatePickerOpen(uploadTimesheetForm.get('invoice_date'))">
          <div class="error-div">
            @if (uploadTimesheetForm.get('invoice_date')?.errors?.['required'] &&
            (uploadTimesheetForm.get('invoice_date')?.touched || uploadTimesheetForm.get('invoice_date')?.dirty)) {
            <b><small class="error-message">*Invoice Date field is required</small></b>
            }
            @if (uploadTimesheetForm.get('invoice_date')?.errors?.['pastDateTooFar'] &&
            (uploadTimesheetForm.get('invoice_date')?.dirty)) {
            <b><small class="error-message">*Date can't be less than a year in the past</small></b>
            }
            @if (uploadTimesheetForm.get('invoice_date')?.errors?.['futureDateTooFar'] &&
            (uploadTimesheetForm.get('invoice_date')?.dirty)) {
            <b><small class="error-message">*Date can't be more than a year in the future</small></b>
            }
          </div>
        </div>
        <div class="upload-form-group">
          <label for="timesheet_file">Choose File <span class="text-danger">*</span></label>
          <input type="file" accept=".csv, image/*, application/pdf" (change)="onFileChange($event)">

        </div>
        <div class="d-flex justify-content-center">
          <button class="btn btn-success me-2" [disabled]="!(this.uploadTimesheetForm.valid)">Upload</button>
          <button type="reset" class="btn btn-secondary" (click)="resetForm(uploadTimesheetForm)">Reset</button>
        </div>
      </form>
    </div>
  </div>
</app-modal>
